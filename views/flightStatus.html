<!DOCTYPE html>
<html class="no-js" lang="en">
    <head>
        <title>DigitalRe-flightStatus</title>
        <meta http-equiv="x-ua-compatible" content="ie=edge">
	    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Raleway:400,800">
        <link rel='stylesheet' href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
        <link rel="stylesheet" href="/css/bootstrap.css">
        <link rel="stylesheet" href="/css/styles.css">
    </head>
    <body>
        <div class="container">
            <nav class="navbar navbar-expand-lg navbar-dark bg-primary pt-0 pb-0">
                    <a class="navbar-brand" href="#">DigitalRe</a>
                    
                    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent">
                            <span class="navbar-toggler-icon"></span>
                    </button>
                    
                    <div class="collapse navbar-collapse" id="navbarSupportedContent">
                        <ul class="navbar-nav ml-auto">
                            <li class="nav-item">
                                <a class="nav-link" href="#">Home</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#">About</a>
                            </li>
                            <li class="nav-item dropdown">
                                    <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" data-toggle="dropdown">
                                        Products
                                    </a>
                                    <div class="dropdown-menu">
                                        <a class="dropdown-item" href="#">Product 1</a>
                                        <a class="dropdown-item" href="#">Product 2</a>
                                        <div class="dropdown-divider"></div>
                                        <a class="dropdown-item" href="#">Another Product</a>
                                    </div>
                                </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#">Contact</a>
                            </li>
                        </ul>
                    </div>
                </nav>
                <div class="jumbotron pt-3 mb-3">
                    <h1 class="display-5 mb-3">Search Flight</h1> 
                    <form>
                        <div class="form-row">
                            <div class="form-group col-md-3">
                                <label for="inputDate">Arrival Date</label>
                                <!--<input type="date" class="form-control" id="inputDate" min="2018-05-20" max="2018-05-22">
                                -->
                                    <input type="date" class="form-control" id="inputDate">
                                <div class="form-group mt-2">
                                    <button type="button" class="btn btn-primary mb-2" onclick="searchflightsDB()">Search</button>
                                </div>
                            </div>
                            <div class="form-group col-md-9">
                                <div id="flightResult"></div>
                               
                            </div>
                        </div>
                    </form>  
                </div>
                <div class="jumbotron pt-3 mb-3">
                        <h1 class="display-5 mb-3">Close transection</h1>   
                </div>
                <!--Footer-->
                <footer class="page-footer font-small blue pt-4 mt-4">
                    <!--Footer Links-->
                    <div class="container-fluid text-center text-md-left">
                        <div class="row">
                
                            <!--First column-->
                            <div class="col-md-12">
                                <h5 class="text-uppercase">Footer Content</h5>
                                <p>Here you can use rows and columns here to organize your footer content.</p>
                            </div>
                            <!--/.First column-->
                    </div>
                    <!--/.Footer Links-->
                </footer>
                <!--/.Footer-->
                <!--Copyright-->
                <div class="footer-copyright py-2 text-center">
                        Â© 2018 Copyright:
                        <a href="#"> DigitalRe.com </a>
                </div>
                <!--/.Copyright-->
            </div>
        </div>
        <script src="/js/jquery.min.js"></script>
        <script src="/js/popper.min.js"></script>
        <script src="/js/bootstrap.min.js"></script>
        <script>
            var closeCompFlight = any;
            function searchflightsDB(){
                //$("#d_date").val();
                var strPost = 'a_date='+$("#inputDate").val();
                //console.log(strPost);
                var xhttp = new XMLHttpRequest();
                xhttp.onreadystatechange = function() {
                    if (this.readyState == 4 && this.status == 200) {
                        //$("#loader").hide();
                        res_flights = JSON.parse(this.responseText)
                        list_flights(res_flights);
                        closeCompFlight = res_flights
                        //document.getElementById("tmpresult").innerHTML = this.responseText;
                    }
                };
                xhttp.open("POST", "api/searchflightdb", true);
                xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
                //xhttp.send("fname=Henry&lname=Ford");
                xhttp.send(strPost);
            }

            function list_flights(json_flights){
                    //alert(Object.keys(json_flights).length);
                    var text ='';
                    if(Object.keys(json_flights).length==0){
                    //alert("No available flights.");
                        text+="<p>No flight.</p>";
                    }
                    else{    
                        text += '<table class="table table-bordered">'
                        text += '<thead><tr><th>Flight</th><th>Planed Arrival</th><th>Actual Arrival</th><th>Delay(minute)</th></tr></thead>'
                        text += '<tbody>'
                        for(x in json_flights){
                            text +='<tr>'
                            text +='<td>'+json_flights[x]["carrierFsCode"]+json_flights[x]["flightNumber"]+'</td>'
                            text +='<td>'+json_flights[x]["p_local_date"]+',T'+json_flights[x]["p_local_time"]+'</td>'
                            text +='<td>'+json_flights[x]["a_local_date"]+',T'+json_flights[x]["a_local_time"]+'</td>'
                            text += findTimeDiff(json_flights[x])
                            text += '</tr>' 
                        }
                        text+='</tbody></table>'
                        text+='<button type="button" class="btn btn-primary mb-2" onclick="compensate()">Close/Compensate</button>'
                    }
                   document.getElementById("flightResult").innerHTML = text;
                }
            function findTimeDiff(obj){
                //6 numbers specify year, month, day, hour, minute, second:
                var arrA_date = obj.a_local_date.split('-')
                var arrA_time = obj.a_local_time.split(':')
                var actArr = new Date(arrA_date[0],arrA_date[1],arrA_date[2],arrA_time[0],arrA_time[1],arrA_time[2])
                var arrP_date = obj.p_local_date.split('-')
                var arrP_time = obj.p_local_time.split(':')
                var plnArr = new Date(arrP_date[0],arrP_date[1],arrP_date[2],arrP_time[0],arrP_time[1],arrP_time[2])
                var difftime = ((actArr - plnArr)/1000)/60
                var textresult = ""
                if (difftime > 120)
                    textresult= '<td  class="text-danger">'+difftime+'</td>' 
                else textresult= '<td  class="text-success">'+difftime+'</td>' 
                return textresult
            }

            function compensate(){
                var strPost = 'a_date='+$("#inputDate").val();
                var xhttp = new XMLHttpRequest();
                xhttp.onreadystatechange = function() {
                    if (this.readyState == 4 && this.status == 200) {
                        res_compensation = JSON.parse(this.responseText)
                        console.log("done")
                    }
                };
                xhttp.open("POST", "api/closeAndCompensation", true);
                xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
                xhttp.send(strPost);
            }
        </script>
    </body>
</html>